# 📅 Booking Service
통합 예약 서비스는 공연, 전시회, 음식점 서비스의 도메인에서 예약 기능을 제공합니다.  
- 공연 서비스에서는 Redis를 활용하여 좌석 관리 및 선점을 수행합니다.  
- 예약 완료 시 Kafka를 통해 메시지를 발행하여 다른 서비스와 연동합니다.  
- Lua 스크립트를 이용해 각 예약 처리의 원자성을 보장하여 동시성 문제를 방지합니다.
- 데이터 일관성을 유지하기 위해 Orchestration 기반의 Saga 패턴을 적용하였습니다.


## ✨ 주요 기능

### 예약 관리
- **예약 생성 및 관리**: 각 도메인별 예약 정보를 받아 예약 관리
- **예약 정보 조회**: 단건/복수 정보 조회

### 예약 세부정보 관리
- **세부정보 생성 및 관리**: 각 도메인별 필요한 세부정보를 관리 디테일 항목에 JSON으로 저장
- **예약 정보 조회**: 단건/복수 정보 조회

### 예약 과정 진행
- **좌석 선점 및 동시성 제어**: Redis와 Lua script를 이용하여 좌석 정보 관리
- **동기 및 비동기 처리 분리**: 시스템 중요도에 따라 동기와 비동기 방식을 나누어 사용하여 트랜젝션 보장 및 시스템간 결합도를 낮춤


## 📝 API 명세

아래의 Google Docs로 확인할 수 있습니다.

[`https://docs.google.com/spreadsheets/d/1erfJV-eh3TtUMcaTJLLNou-vhwnxBvB4MV5cJ72-hw8`](https://docs.google.com/spreadsheets/d/1erfJV-eh3TtUMcaTJLLNou-vhwnxBvB4MV5cJ72-hw8)

## 🛠️ 기술적 의사결정

### Redis Lua script를 활용한 원자성 보장 

#### 요구 사항
- 대규모 요청이 들어와도 안전하게 작동해야 함
- 기존 선점 및 좌석관리 방식이 비효율적이어서 성능적으로 개선이 필요함
 <img width="1157" height="538" alt="image" src="https://github.com/user-attachments/assets/8de14d1c-fa8e-4f1a-a737-c70da3b32026" />


#### 비교 분석
##### 좌석 선점
| 구분 | 개선 전 | 개선 후 |
|------|------|------|
| 성능  | • 낮음<br>• 좌석수 만큼 네트워트 통신 필요 | • 높음<br>• 최초 1회만 통신하고 나머지는 Redis에서 관리 |
| 원자성 | • 락 만료시간 이후 경쟁상태 발생 가능 | • 단일 명령으로 실행하여 원자성 보장 |

#### 결정 및 근거

- **성능 우선**: 대규모 요청에 대비해서 코드 구조적으로도 변경이 필요하고, 성능적으로도 우수한 Lua script 사용
 
#### 개선 후 성능 비교 
테스트 조건 Apache JMeter™ 사용
쓰레드 수 : 500
램프업 시간 : 10
지속 시간 : 180
전체 좌석수 : 10만개


| 지표                   | 개선 전 | 개선 후     |
| -------------------- | ---- | -------- |
| **데이터 처리량 (/sec)**   | 270  | **400**  |
| **평균 (latency, ms)** | 1856 | **1195** |
| **중간값 (Median)**     | 2065 | **1250** |
| **90% 지점 (P90)**     | 2236 | **1567** |
| **95% 지점 (P95)**     | 2257 | **2272** |
| **최대값 (Max)**        | 5164 | **3888** |

결론 : 데이터 처리량 약 40% 증가.



## 🔫 트러블슈팅

### 레디스 락으로 데이터 정합성 문제 해결

#### 문제 정의
- 성능 테스트 중 대규모 요청이 짧은 시간 내에 발생하면서 데이터 정합성 불일치 발생
- 예약 서비스에서 예약 완료 후 공연 서비스 DB에 반영할 때 예약된 횟수와 남은 좌석 수가 일치하지 않음
- 단건으로 호출 시에 정상적으로 작동

#### 원인 분석

**1. 요청이 많을 시에만 정합성 불일치**
- 단건 및 소규모 호출에서는 정합성 일치
- 대규모 호출에서만 정합성 불일치 발생 -> 공연 서비스의 섹션 단계에서 경쟁상태 발생 예상

**2. 공연 서비스에서 좌석 단위에 락 적용**
- 좌석은 예약 서비스에서 원자성을 보장해 주기때문에 락이 불필요

#### 해결 방안 및 결과

**공연 서비스 섹션 관리부분에 락 적용**

- 기존 좌석에서 공연 섹션부분에 락 적용 

**적용 결과**
- 실제 예약 된 좌석 수와 예약 서비스에서 카운팅한 좌석수 일치 확인

